# ── E2E Automation Framework — CI Pipeline ────────────────────────────
name: E2E Automation Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Test suite to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - smoke
          - api
          - ui
          - regression

  schedule:
    # Nightly at 2 AM IST (8:30 PM UTC previous day)
    - cron: "30 20 * * *"

  push:
    branches: [main]

  pull_request:
    branches: [main]

env:
  AUTO_HEADLESS: "true"
  AUTO_ENVIRONMENT: "ci"
  AUTO_LOG_FORMAT: "json"

jobs:
  # ── API Tests (fast, no browser needed) ─────────────────────────────
  api-tests:
    name: API Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run API tests (parallel)
        run: |
          mkdir -p reports/allure-results
          pytest tests/api/ \
            -v \
            -n 2 \
            -m "api" \
            --html=reports/api-report.html \
            --self-contained-html \
            --junitxml=reports/api-results.xml \
            --alluredir=reports/allure-results \
            2>&1 | tee reports/api-test.log

      - name: Upload API test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-reports
          path: reports/
          retention-days: 30

  # ── UI Smoke Tests (parallel via Selenium Grid) ─────────────────────
  ui-smoke:
    name: UI Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size=2g
          --health-cmd="curl -f http://localhost:4444/wd/hub/status || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=30s
        env:
          SE_NODE_MAX_SESSIONS: 3
          SE_NODE_OVERRIDE_MAX_SESSIONS: true
          SE_SESSION_REQUEST_TIMEOUT: 300

    env:
      AUTO_SELENIUM_REMOTE_URL: "http://localhost:4444/wd/hub"
      AUTO_PAGE_LOAD_TIMEOUT: "60"
      AUTO_EXPLICIT_WAIT: "20"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Wait for Selenium Grid
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status | grep -q "ready.*true"; do sleep 2; done'

      - name: Run UI smoke tests (3 workers)
        run: |
          mkdir -p reports/allure-results
          pytest tests/ui/ \
            -v \
            -n 3 \
            -m "smoke and not auth_required" \
            --reruns=1 \
            --reruns-delay=3 \
            --html=reports/ui-smoke-report.html \
            --self-contained-html \
            --junitxml=reports/ui-smoke-results.xml \
            --alluredir=reports/allure-results \
            2>&1 | tee reports/ui-smoke.log

      - name: Generate Allure report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate reports/allure-results -o reports/allure-report --clean || true

      - name: Deploy Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: reports/allure-report
          destination_dir: allure-report

      - name: Upload UI smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-smoke-reports
          path: reports/
          retention-days: 30

  # ── UI Regression Tests (parallel via Selenium Grid — nightly + manual)
  ui-regression:
    name: UI Regression
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: >-
      github.event_name == 'schedule' ||
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'regression' ||
      github.event.inputs.test_suite == 'ui'

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size=2g
          --health-cmd="curl -f http://localhost:4444/wd/hub/status || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=30s
        env:
          SE_NODE_MAX_SESSIONS: 3
          SE_NODE_OVERRIDE_MAX_SESSIONS: true
          SE_SESSION_REQUEST_TIMEOUT: 300

    env:
      AUTO_SELENIUM_REMOTE_URL: "http://localhost:4444/wd/hub"
      AUTO_PAGE_LOAD_TIMEOUT: "60"
      AUTO_EXPLICIT_WAIT: "20"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Wait for Selenium Grid
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:4444/wd/hub/status | grep -q "ready.*true"; do sleep 2; done'

      - name: Run UI regression tests (3 workers)
        run: |
          mkdir -p reports/allure-results
          pytest tests/ui/ \
            -v \
            -n 3 \
            -m "not auth_required" \
            --reruns=2 \
            --reruns-delay=3 \
            --html=reports/ui-regression-report.html \
            --self-contained-html \
            --junitxml=reports/ui-regression-results.xml \
            --alluredir=reports/allure-results \
            2>&1 | tee reports/ui-regression.log

      - name: Generate Allure report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate reports/allure-results -o reports/allure-report --clean || true

      - name: Upload UI regression artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-regression-reports
          path: reports/
          retention-days: 30

  # ── Performance Tests (optional, scheduled/manual only) ─────────────
  performance-tests:
    name: Performance (JMeter)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: >-
      github.event.inputs.test_suite == 'all' ||
      github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v4
        with:
          path: apache-jmeter-5.6.3
          key: jmeter-5.6.3

      - name: Set up JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter-5.6.3/bin" >> $GITHUB_PATH

      - name: Run search load test
        run: |
          mkdir -p reports/jmeter
          jmeter -n \
            -t performance/test_plans/nykaa_search_load.jmx \
            -l reports/jmeter/search-results.jtl \
            -e -o reports/jmeter/search-dashboard/ \
            || true

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: reports/jmeter/
          retention-days: 30
