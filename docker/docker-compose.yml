# ── E2E Automation Framework — Docker Compose ────────────────────────
#
# Two services:
#   selenium-chrome  — Standalone Chrome with WebDriver
#   test-runner      — Python container running pytest
#
# Usage:
#   docker compose -f docker/docker-compose.yml up --build --abort-on-container-exit
#   docker compose -f docker/docker-compose.yml down
#
# Debug (watch tests live):
#   Open http://localhost:7900 in browser (noVNC, password: "secret")
#
# Reports: ./reports/report.html
# ──────────────────────────────────────────────────────────────────────

services:
  selenium-chrome:
    image: selenium/standalone-chrome:latest
    restart: "no"
    ports:
      - "4444:4444"       # WebDriver
      - "7900:7900"       # noVNC (visual debugging)
    environment:
      - SE_NODE_MAX_SESSIONS=4
      - SE_SESSION_REQUEST_TIMEOUT=300
      - SE_NODE_OVERRIDE_MAX_SESSIONS=true
    shm_size: "2g"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - automation

  test-runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: "no"
    environment:
      - AUTO_HEADLESS=true
      - AUTO_SELENIUM_REMOTE_URL=http://selenium-chrome:4444/wd/hub
      - AUTO_ENVIRONMENT=ci
      - AUTO_REPORT_DIR=reports
      - AUTO_LOG_FORMAT=json
    volumes:
      - ../reports:/automation/reports
    depends_on:
      selenium-chrome:
        condition: service_healthy
    networks:
      - automation

  # ── Selenium Grid (for scaling to multi-browser) ──────────────────
  # Uncomment below to run a full Selenium Grid with hub + nodes.
  # Usage: docker compose --profile grid up
  #
  # selenium-hub:
  #   image: selenium/hub:131.0
  #   profiles: ["grid"]
  #   ports:
  #     - "4442:4442"
  #     - "4443:4443"
  #     - "4444:4444"
  #   networks:
  #     - automation
  #
  # chrome-node:
  #   image: selenium/node-chrome:131.0
  #   profiles: ["grid"]
  #   depends_on:
  #     - selenium-hub
  #   environment:
  #     - SE_EVENT_BUS_HOST=selenium-hub
  #     - SE_EVENT_BUS_PUBLISH_PORT=4442
  #     - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
  #     - SE_NODE_MAX_SESSIONS=4
  #   shm_size: "2g"
  #   networks:
  #     - automation
  #
  # firefox-node:
  #   image: selenium/node-firefox:131.0
  #   profiles: ["grid"]
  #   depends_on:
  #     - selenium-hub
  #   environment:
  #     - SE_EVENT_BUS_HOST=selenium-hub
  #     - SE_EVENT_BUS_PUBLISH_PORT=4442
  #     - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
  #     - SE_NODE_MAX_SESSIONS=4
  #   shm_size: "2g"
  #   networks:
  #     - automation

networks:
  automation:
    driver: bridge
